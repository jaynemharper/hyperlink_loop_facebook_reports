from selenium import webdriver
import time
from datetime import datetime, timedelta
import glob
import os
import tinys3

# Identify Variables
downloads_folder = 'C:/Users/jayne.harper/Downloads/'
chromedriver_path = 'C:/Users\jayne.harper\chromedriver.exe'
fb_url_login = 'https://business.facebook.com/login'
fb_username = 'sq1socialmanager@gmail.com'
fb_password = 'Square144!2016'
s3_default_bucket = 'ansira-lambda-lagoon'
end_folder = 'facebook/facebook_account_summaries/daily_account_summary/'
s3_access_key = 'AKIAJ3HZGA2G32QC2IFQ'
s3_secret_key = '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'

# Define date formulas for f-string links & print for debug
date_until = datetime.now()
date_from = datetime.now()-timedelta(days=35)
print(f"https://business.facebook.com/home/reporting/exports/?business_id=855276107850968&fields[0]=impressions&fields[1]=reach&fields[2]=frequency&fields[3]=cpm&fields[4]=total_actions&fields[5]=spend&filters[0][field]=account_status&filters[0][operator]=EQUAL&filters[0][value]=1&since={date_from:%Y-%m-%d}&until={date_until:%Y-%m-%d}&timezone_id=1")
print(f"https://business.facebook.com/home/reporting/exports/?business_id=697627383655897&fields[0]=impressions&fields[1]=reach&fields[2]=frequency&fields[3]=cpm&fields[4]=total_actions&fields[5]=spend&filters[0][field]=account_status&filters[0][operator]=EQUAL&filters[0][value]=1&since={date_from:%Y-%m-%d}&until={date_until:%Y-%m-%d}&timezone_id=1")

var_fb_url1 = f"https://business.facebook.com/home/reporting/exports/?business_id=855276107850968&fields[0]=impressions&fields[1]=reach&fields[2]=frequency&fields[3]=cpm&fields[4]=total_actions&fields[5]=spend&filters[0][field]=account_status&filters[0][operator]=EQUAL&filters[0][value]=1&since={date_from:%Y-%m-%d}&until={date_until:%Y-%m-%d}&timezone_id=1"
var_fb_url2 = f"https://business.facebook.com/home/reporting/exports/?business_id=697627383655897&fields[0]=impressions&fields[1]=reach&fields[2]=frequency&fields[3]=cpm&fields[4]=total_actions&fields[5]=spend&filters[0][field]=account_status&filters[0][operator]=EQUAL&filters[0][value]=1&since={date_from:%Y-%m-%d}&until={date_until:%Y-%m-%d}&timezone_id=1"


# Login to Facebook
browser = webdriver.Chrome(executable_path=chromedriver_path)
browser.get(fb_url_login)
browser.find_element_by_id("email").send_keys(fb_username)
browser.find_element_by_id("pass").send_keys(fb_password)
browser.find_element_by_id("loginbutton").click()

# click hyperlinks
browser.get(var_fb_url1)
browser.get(var_fb_url2)
browser.close()

# set up AWS S3 connection for upload
conn = tinys3.Connection(s3_access_key, s3_secret_key, s3_default_bucket, tls=True)

# upload reports to S3
for filename in glob.glob(os.path.join(downloads_folder, '*Sq1 West Business Page Report*')):
    f = open(filename, 'rb')
    conn.upload(end_folder + ' Sq1 West Business Page Report.csv', f)
for filename in glob.glob(os.path.join(downloads_folder, '*Ansira Engagement*')):
    g = open(filename, 'rb')
    conn.upload(end_folder + ' Ansira Engagement Marketing Report.csv', g)


